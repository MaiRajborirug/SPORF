---
title: "Scaling at each node: Experiment 02"
author: "Jesse L. Patsolic"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r render, include = FALSE, eval = FALSE, echo = FALSE}
rm(list = ls())
require(rmarkdown)
render("Scaling-at-each-node02.Rmd")
system("open Scaling-at-each-node02.html")
```

```{r setup, include = FALSE}
set.seed(2019)
require(knitr)
require(gridExtra)
require(ggplot2)
require(rerf)
require(data.table)
require(scales)
#options(digits = 20)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>", 
  fig.width = 8,
  fig.height = 8,
  dev = 'png'
)
```

# Introduction

## Toy dataset 2

Consider the regions described by the sets

Let $\epsilon = 10^{-3}$

$X = \{(x_1, x_2) | \, x_1 \in (10^{-4}, 10^{-3}), x_2 \in  (10^4, 10^5), x_2 < 10^8 \cdot x_1)\} \cup \\
(x_1, x_2) | \, x_1 \in (10^{-3}, 10^{3}), x_2 \in  (10^5, 10^5 + \epsilon), x_2 > 10^{-6} \cdot x_1 + 999,999)\} \\$

$O = \{(x_1, x_2) | \, x_1 \in (10^{-4}, 10^{-3}), x_2 \in  (10^4, 10^5 + \epsilon), x_2 > 10^8 \cdot x_1)\} \cup \\ 
\{(x_1, x_2) | \, x_1 \in (10^{-3}, 10^{3}), x_2 \in  (10^5, 10^5 + \epsilon), 
x_2 < \frac{1}{999999} \cdot x_1 + \frac{99999899999999}{999999000}\} \\$ 


```{r}
N <- 1e5 / 4
n <- 1e4 / 4
eps <- 1

r12 <- data.frame(x = runif(N, 1e-4, 1e-3), y = runif(N, 1e4, 1e5))
r1 <- r12[with(r12, y < 1e8 * x), ][1:n, ]
r2 <- r12[with(r12, y >= 1e8 * x), ][1:n, ]

m1 <- 1e8
l1 <- function(x) m1 * x


m2 <- (1e3 * eps) / 999999
b <- 1e5 - (eps / 999999)
l2 <- function(x) m2 * x + b


r34 <- data.frame(x = runif(1000 * N, 1e-3, 1e3), y = runif(1000 * N, 1e5, 1e5 + eps))
r3 <- r34[with(r34, y < l2(x) ), ][1:n, ]
r4 <- r34[with(r34, y >= l2(x)), ][1:n, ]


Xrb <- data.frame(rbind(r1, r3, r2, r4))
Yrb <- rep(c(1,3,2,4), each = n)
```


### note the differing scales

```{r}
c1 <- rep(c(0,1), c(20,80))
c2 <- rep(c(2,0), c(35,65))

lom <- cbind(c1, c2)
options(digits = 3)
layout(lom)
plot(Xrb, col = Yrb, pch = '.', xlim = c(1e-4,1e-3))
curve(l1, add = TRUE)
plot(Xrb, col = Yrb, pch = '.', xlim = c(1e-3,1e3), ylim = c(1e5, 1e5 +1), axes = FALSE)
axis(side = 1, at = seq(1e-3, 1e3, length = 3))
axis(side = 2, at = seq(1e5, 1e5 + 1, length = 3))
curve(l2, add = TRUE)
```


## Train some forests

```{r, RerF-setup2}
FUN <- RandMatBinary
mdepth <- 3L
num.cores <- 1L
paramList <- list(p = 2, d = 8, sparsity = 0.6, prob = 0.5)
ntrees <- 1L
```

```{r}
seed <- 1234
set.seed(seed)

f2 <- RerF(Xrb, Yrb, FUN = FUN, paramList = paramList, scaleAtNode = FALSE, trees = ntrees, max.depth = mdepth, store.oob = TRUE, store.impurity = TRUE, num.cores = num.cores, seed = seed)
f2.pred <- Predict(Xrb, f2)

f2s <- RerF(Xrb, Yrb, FUN = FUN, paramList = paramList, scaleAtNode = TRUE, trees = ntrees, max.depth = mdepth, store.oob = TRUE, store.impurity = TRUE, num.cores = num.cores, seed = seed)
f2s.pred <- Predict(Xrb, f2s)

RcppZiggurat::zsetseed(seed)
f2c <- RerF(Xrb, Yrb, FUN = RandMatContinuous,  paramList = paramList, scaleAtNode = FALSE, trees = ntrees, max.depth = mdepth, store.oob = TRUE, store.impurity = TRUE, num.cores = num.cores, seed = seed)
f2c.pred <- Predict(Xrb, f2c)

RcppZiggurat::zsetseed(seed)
f2cs <- RerF(Xrb, Yrb, FUN = RandMatContinuous,  paramList = paramList, scaleAtNode = TRUE, trees = ntrees, max.depth = mdepth, store.oob = TRUE, store.impurity = TRUE, num.cores = num.cores, seed = seed)
f2cs.pred <- Predict(Xrb, f2cs)
```


### Scaled forest (RandMatBinary)

```{r, echo = FALSE, results = 'asis'}
kable(PrintTree(f2s, 1))
```

#### Confusion matrix

```{r, echo = FALSE, results = 'asis'}
kable(table(f2s.pred, Yrb))
```

#### Percent error
```{r}
mean(f2s.pred != Yrb)
```

### Un-scaled forest (RandMatBinary)

```{r, results = 'asis'}
kable(PrintTree(f2, 1))
```

#### Confusion matrix

```{r, echo = FALSE, results = 'asis'}
kable(table(f2.pred, Yrb))
```

#### Percent error

```{r}
mean(f2.pred != Yrb)
```

### Un-scaled forest (RandMatContinuous)

```{r, results = 'asis'}
kable(PrintTree(f2c, 1))
```

#### Confusion matrix

```{r, echo = FALSE, results = 'asis'}
kable(table(f2c.pred, Yrb))
```


#### Percent error

```{r}
mean(f2c.pred != Yrb)
```

### Scaled forest (RandMatContinuous)

```{r, results = 'asis'}
kable(PrintTree(f2cs, 1))
```

#### Confusion matrix

```{r, echo = FALSE, results = 'asis'}
kable(table(f2cs.pred, Yrb))
```


#### Percent error

```{r}
mean(f2cs.pred != Yrb)
```



## Train some forests on the 2-class problem


```{r, RerF-setup2-2}
Yrb[Yrb == 3] <- 1
Yrb[Yrb == 4] <- 2

FUN <- RandMatBinary
mdepth <- 3L
num.cores <- 1L
paramList <- list(p = 2, d = 8, sparsity = 0.6, prob = 0.5)
ntrees <- 1L
```

### note the differing scales

```{r}
options(digits = 3)
layout(lom)
plot(Xrb, col = Yrb, pch = '.', xlim = c(1e-4,1e-3))
curve(l1, add = TRUE)
plot(Xrb, col = Yrb, pch = '.', xlim = c(1e-3,1e3), ylim = c(1e5, 1e5 +1), axes = FALSE)
axis(side = 1, at = c(1e-3, 500, 1e3))
axis(side = 2, at = seq(1e5, 1e5 + 1, length = 3))
curve(l2, add = TRUE)
```

```{r}
seed <- 1234
set.seed(seed)

f2 <- RerF(Xrb, Yrb, FUN = FUN, paramList = paramList, scaleAtNode = FALSE, trees = ntrees, max.depth = mdepth, store.oob = TRUE, store.impurity = TRUE, num.cores = num.cores, seed = seed)
f2.pred <- Predict(Xrb, f2)

f2s <- RerF(Xrb, Yrb, FUN = FUN, paramList = paramList, scaleAtNode = TRUE, trees = ntrees, max.depth = mdepth, store.oob = TRUE, store.impurity = TRUE, num.cores = num.cores, seed = seed)
f2s.pred <- Predict(Xrb, f2s)

RcppZiggurat::zsetseed(seed)
f2c <- RerF(Xrb, Yrb, FUN = RandMatContinuous,  paramList = paramList, scaleAtNode = FALSE, trees = ntrees, max.depth = mdepth, store.oob = TRUE, store.impurity = TRUE, num.cores = num.cores, seed = seed)
f2c.pred <- Predict(Xrb, f2c)

RcppZiggurat::zsetseed(seed)
f2cs <- RerF(Xrb, Yrb, FUN = RandMatContinuous,  paramList = paramList, scaleAtNode = TRUE, trees = ntrees, max.depth = mdepth, store.oob = TRUE, store.impurity = TRUE, num.cores = num.cores, seed = seed)
f2cs.pred <- Predict(Xrb, f2cs)
```


### Scaled forest (RandMatBinary)

```{r, echo = FALSE, results = 'asis'}
kable(PrintTree(f2s, 1))
```

#### Confusion matrix

```{r, echo = FALSE, results = 'asis'}
kable(table(f2s.pred, Yrb))
```

#### Percent error
```{r}
mean(f2s.pred != Yrb)
```

### Un-scaled forest (RandMatBinary)

```{r, results = 'asis'}
kable(PrintTree(f2, 1))
```

#### Confusion matrix

```{r, echo = FALSE, results = 'asis'}
kable(table(f2.pred, Yrb))
```

#### Percent error

```{r}
mean(f2.pred != Yrb)
```

### Un-scaled forest (RandMatContinuous)

```{r, results = 'asis'}
kable(PrintTree(f2c, 1))
```

#### Confusion matrix

```{r, echo = FALSE, results = 'asis'}
kable(table(f2c.pred, Yrb))
```


#### Percent error

```{r}
mean(f2c.pred != Yrb)
```

### Scaled forest (RandMatContinuous)

```{r, results = 'asis'}
kable(PrintTree(f2cs, 1))
```

#### Confusion matrix

```{r, echo = FALSE, results = 'asis'}
kable(table(f2cs.pred, Yrb))
```


#### Percent error

```{r}
mean(f2cs.pred != Yrb)
```


